@model IEnumerable<ProjectSampleDBData>
@using System.Globalization
@using Resources
@inject ILocalizer localizer
@{
    ViewData["Title"] = "Step3_2";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<section class="section_top">
    <div class="container">
        <ul class="bread_crumb">
            <li>
                @Html.ActionLink(localizer.Text.project_list, "ProjectIndex", "Home")
            </li>
            <li>
                <a href="@Url.Action("Step3_2", "ProjectStep", new { proj_id = ViewData["ProjectId"], project_name = ViewData["ProjectName"] })">@ViewData["ProjectName"]</a>
            </li>
        </ul>
    </div>
</section>
<section class="project_wrapper">
  <div class="container">
	<div class="row">
	  <div class="col-sm-12">
		<div class="col-sm-3">
			<div class="status_bar">
				<h4 class="title">@ViewData["ProjectName"]</h4>
				<div class="status">
					<div class="status_f">
						<h6>@localizer.Text.step1</h6>
						<p>@localizer.Text.step1_menu_list</p>
						<h3>1</h3>
					</div>
				</div>
				<div class="status">
					<div class="status_d">
						<h6>@localizer.Text.step2</h6>
						<p>@localizer.Text.step2_menu_list</p>
						<h3>2</h3>
					</div>
				</div>
				<div class="status">
					<div class="status_d">
						<h6>@localizer.Text.step3</h6>
						<p>@localizer.Text.step3_menu_list</p>
						<h3>3</h3>
					</div>
				</div>
				<div class="status">
					<div class="status_u">
						<h6>@localizer.Text.step4</h6>
						<p>@localizer.Text.step4_menu_list</p>
						<h3>4</h3>
					</div>
				</div>
				<div class="status">
					<div class="status_u">
						<h6>@localizer.Text.step5</h6>
						<p>@localizer.Text.step5_menu_list</p>
						<h3>5</h3>
					</div>
				</div>
			</div>
		 </div>
		 <div class="col-sm-9">
			<div class="project_content">
				<h4 class="title">@localizer.Text.gen_preview</h4>
				<div class="container gene_preview">
					@{
						int i = 1;
						foreach (var item in Model)
						{
							string tablenum = "gene_preview_" + i.ToString();
							string tb = "tb_" + i.ToString();
							string qivalue = "qivalue_" + i.ToString();
							<h6>@localizer.Text.dataset_name：<label id="@tb">@item.pro_tb</label></h6>
							string minkvalue = "";
							if (ViewData["kvalue"].ToString() == "")
							{
								minkvalue = item.minKvalue.ToString();
							}
							else
							{
								minkvalue = ViewData["kvalue"].ToString();
							}
							//string qivalue
							<h6>
								@localizer.Text.k_value：<label id="minkvalue"> @minkvalue</label>
							</h6>
							<table class="table table-hover table-bordered" id="@tablenum">
								<thead class="thead-dark">
									<tr>
										<th>@localizer.Text.col_name</th>
										<th>@localizer.Text.gen_setting</th>
									</tr>
								</thead>
								<tbody></tbody>
							</table>
							i++;
							@*<label id="@qivalue" style="display:none">@item.qi_col</label>
								<label id="@qivalue" style="display:none">@item.qi_col</label>*@
						}
					}
				</div>
				<label id="tbcount" style="display:none">@Model.Count()</label>
				<label id="pid" style="display:none">@ViewData["ProjectId"]</label>
				<label id="pname" style="display:none">@ViewData["ProjectName"]</label>
				<label id="genspark" style="display:none">@ViewData["gensparkstatus"]</label>
				<label id="selectqigenvalue" style="display:none">@ViewData["selectqigenvalue"]</label>
				<label id="selectqivalue" style="display:none">@ViewData["selectqivalue"]</label>
				<label id="generror" style="display:none">@localizer.Message.gen_error</label>
				<label id="gening" style="display:none">@localizer.Message.gen_processing</label>
				<label id="genjobing" style="display:none">@localizer.Message.gen_job</label>
				<label id="saveerror" style="display:none">@localizer.Message.save_col_error</label>
				<div class="btn btn_sbe btn_back" id="back" onclick="javascript: history.back(-1)">@localizer.Text.back</div>
				@*<div class="btn btn_sbe btn_back" id="save">儲存</div>*@
				<div class="btn btn_mbs btn_next" id="next">
					@*   @Html.ActionLink("執行去識別化", "Step4", "ProjectStep", new {id = "btnGen", onclick= "javascript:getGEN();return false;" }, new { @class = "a_unstyled" })*@
					<a class="a_unstyled" href="javascript:getGEN();">@localizer.Text.next</a>
					@*<a class="a_unstyled" href="step5_2.html">下一步</a>*@
				</div>
			</div>
		  </div>
	    </div>
	  </div>
	</div>
</section>
<script>
	function getGEN() {
		var genstatus = $('#genspark').text();
		var generror = $('#generror').text();
		var gening = $('#gening').text();
		var saveerror = $('#saveerror').text();
		var genjobing = $('#genjobing').text();
		if (genstatus == "0") {
			alert(gening);
			var pid = $('#pid').text();;
			var pname = $('#pname').text();
			var kvalue = $('#minkvalue').text();

			var tbName = "";
			var tbcount = $('#tbcount').text();
			//var selectqivalue = $('#selectqigenvalue').text();
			var selectqigenvalue = $('#selectqigenvalue').text();
			for (var i = 0; i < parseInt(tbcount); i++) {
				var tbnm = "#tb_" + (i + 1).toString();
				var tbn = $(tbnm).text();
				tbName = tbn + ",";
			}
            tbName = tbName.substr(0, tbName.length - 1);

			$.ajax({
				type: "get",
				url: "/api/WebAPI/Generalizationasync",
				contentType: "application/json",
				async: false,
				data:
				{
					pid: pid, pname: pname, selectqivalue: selectqigenvalue, k_value: kvalue, tablename: tbName
				},
				success: function (response) {
					// alert(pname);
					if (!response) {
						alert(generror);
					}
					else {
						location.href = "@Url.Action("ProjectIndex", "Home")";
					}

				},
				error: function (response) {
					alert(saveerror);
				}
			});
		}
		else {
			alert(genjobing);
		}
	}
</script>
<script>

	var tbcount = $('#tbcount').text();
	var selectqigenvalue = $('#selectqivalue').text();
	//alert(selectqigenvalue);
	var colqiarr = new Array();
	colqiarr = selectqigenvalue.split(',')
	for (var i = 0; i < parseInt(tbcount); i++) {
		//string tablenum = "gene_preview_" + i.ToString();
		//var qi_title = "#gene_preview_" + (i + 1).toString();
		//var fielddata = $(qi_title).text();
		//alert(colqiarr.length);
		//alert(colqiarr[i]);
		var gene_pr = "#gene_preview_" + (i + 1).toString()
		$(gene_pr).append(colqiarr[i]);
	}
</script>

